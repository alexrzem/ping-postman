{
	"info": {
		"_postman_id": "d1949701-8a84-427e-b9f4-d090f22a80da",
		"name": "PingOne Use Case: Configure a PKCE Authentication Workflow",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Step 1: Create the application connection",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"postman.setEnvironmentVariable(\"PKCEAppID\", jsonData.id);",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{accessToken}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"warning": "This is a duplicate header and will be overridden by the Authorization header generated by Postman.",
						"key": "Authorization",
						"value": "Bearer {{jwtToken}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"name\": \"UseCasePKCEApp\",\n    \"description\": \"this is my use case PKCE application\",\n    \"pkceEnforcement\": \"S256_REQUIRED\",\n    \"enabled\": true,\n    \"type\": \"NATIVE_APP\",\n    \"protocol\": \"OPENID_CONNECT\",\n    \"responseTypes\": [\n        \"CODE\",\n        \"TOKEN\",\n        \"ID_TOKEN\"\n    ],\n    \"grantTypes\": [\n        \"AUTHORIZATION_CODE\",\n        \"IMPLICIT\"\n    ],\n    \"tokenEndpointAuthMethod\": \"NONE\",\n    \"postLogoutRedirectUris\": [\n        \"https://www.example.com\"\n    ],\n    \"redirectUris\": [\n        \"https://www.example.com\"\n    ]\n}"
				},
				"url": {
					"raw": "{{apiPath}}/environments/{{envID}}/applications",
					"host": [
						"{{apiPath}}"
					],
					"path": [
						"environments",
						"{{envID}}",
						"applications"
					]
				}
			},
			"response": []
		},
		{
			"name": "Step 2: Submit the authorize request",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const url = require('url');",
							"const querystring = require('querystring');",
							"const Cookie = require('postman-collection').Cookie;",
							"",
							"console.log(\"--------------->Request info:\");",
							"const requestParams = querystring.parse(pm.request.url.query.toString());",
							"if (requestParams.state) {",
							"  console.log(\"state was: \" + requestParams.state);",
							"  pm.environment.set(\"expectState\", \"true\");",
							"} else {",
							"  console.log(\"No state!\");",
							"  pm.environment.set(\"expectState\", \"false\");",
							"}",
							"if (requestParams.nonce) {",
							"  console.log(\"nonce was: \" + requestParams.nonce);",
							"} else {",
							"  console.log(\"No nonce!\");",
							"}",
							"if (requestParams.code_challenge) {",
							"  console.log(\"code_challenge was: \" + requestParams.code_challenge);",
							"  console.log(\"code_verifier is now: \" + pm.environment.get(\"codeVerifier\"));",
							"} else {",
							"  console.log(\"No code_challenge!\");",
							"}",
							"var isPiFlow;",
							"if (requestParams.response_mode && requestParams.response_mode === \"pi.flow\") {",
							"  isPiFlow = true;",
							"  pm.environment.set(\"piFlowMode\", \"true\");",
							"} else {",
							"  isPiFlow = false;",
							"  pm.environment.set(\"piFlowMode\", \"false\");",
							"}",
							"console.log(\"pi.flow request: \" + isPiFlow);",
							"",
							"console.log(\"<---------------Response info:\");",
							"if (isPiFlow) {",
							"  pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"  });",
							"",
							"  pm.test(\"Response contains a 'status', as well as expected info for that status\", function () {",
							"    const jsonData = pm.response.json();",
							"    const flowStatus = jsonData.status;",
							"    if (flowStatus) {",
							"      pm.expect(flowStatus).to.be.a('string');",
							"      console.log(\"Flow status is \" + flowStatus);",
							"      switch (flowStatus) {",
							"        case \"COMPLETED\":",
							"          const authorizeResponse = jsonData.authorizeResponse;",
							"          pm.expect(authorizeResponse).to.be.an('object');",
							"          if (pm.environment.get(\"expectState\") === \"true\") {",
							"            if (authorizeResponse.state) {",
							"              pm.expect(authorizeResponse.state).to.equal(pm.variables.get(\"state\"));",
							"            } else {",
							"              console.log(\"Could not find state in Location header value.\");",
							"              pm.expect.fail(\"Could not find state in Location header value.\");",
							"            }",
							"          } else if (authorizeResponse.state) {",
							"            console.log(\"Unexpected state in Location header value.\");",
							"            pm.expect.fail(\"Unexpected state in Location header value.\");",
							"          }",
							"          if (authorizeResponse.code) {",
							"            pm.expect(authorizeResponse.code).to.be.a('string');",
							"            pm.environment.set(\"authCode\", authorizeResponse.code);",
							"            console.log(\"authCode is set\");",
							"          } else if (authorizeResponse.access_token || authorizeResponse.id_token) {",
							"            if (authorizeResponse.access_token) {",
							"              pm.expect(authorizeResponse.access_token).to.be.a('string');",
							"              pm.environment.set(\"oauthToken\", authorizeResponse.access_token);",
							"              console.log(\"oauthToken is set\");",
							"            }",
							"            if (authorizeResponse.id_token) {",
							"              pm.expect(authorizeResponse.id_token).to.be.a('string');",
							"              pm.environment.set(\"idToken\", authorizeResponse.id_token);",
							"              console.log(\"idToken is set\");",
							"            }",
							"          }",
							"          break;",
							"        case \"FAILED\":",
							"          const flowError = jsonData.error;",
							"          pm.expect(flowError).to.be.an('object');",
							"          console.log(\"An error occurred: \");",
							"          console.log(JSON.stringify(flowError));",
							"          pm.expect.fail(\"Flow FAILED.\");",
							"          break;",
							"        default:",
							"          pm.expect(jsonData.id).to.be.a('string');",
							"          pm.environment.set('flowID', jsonData.id);",
							"          console.log(\"flowID is now: \" + pm.environment.get(\"flowID\"));",
							"      }",
							"    } else {",
							"      const errorDetails = jsonData.details;",
							"      pm.expect(errorDetails).to.be.an('array');",
							"      console.log(\"An error occurred: \");",
							"      console.log(JSON.stringify(errorDetails[0]));",
							"    }",
							"  });",
							"} else {",
							"  pm.test(\"Status code is 302\", function () {",
							"    pm.response.to.have.status(302);",
							"  });",
							"",
							"  const loc = url.parse(pm.response.headers.get(\"Location\"));",
							"  var params = {};",
							"  if (loc.hash) {",
							"    params = querystring.parse(loc.hash.substring(1));",
							"  } else {",
							"    params = querystring.parse(loc.query);",
							"  }",
							"",
							"  pm.test(\"Location header contains a 'flowId', an auth 'code', or an 'access_token' and/or 'id_token'\", function () {",
							"    if (params.flowId) {",
							"      pm.expect(params.flowId).to.be.a('string');",
							"      pm.environment.set('flowID', params.flowId);",
							"      console.log(\"flowID is now: \" + pm.environment.get(\"flowID\"));",
							"    } else if (params.code) {",
							"      if (pm.environment.get(\"expectState\") === \"true\") {",
							"        if (params.state) {",
							"          pm.expect(params.state).to.equal(pm.variables.get(\"state\"));",
							"        } else {",
							"          console.log(\"Could not find state in Location header value.\");",
							"          pm.expect.fail(\"Could not find state in Location header value.\");",
							"        }",
							"      } else if (params.state) {",
							"        console.log(\"Unexpected state in Location header value.\");",
							"        pm.expect.fail(\"Unexpected state in Location header value.\");",
							"      }",
							"      pm.expect(params.code).to.be.a('string');",
							"      pm.environment.set(\"authCode\", params.code);",
							"      console.log(\"authCode is set\");",
							"    } else if (params.access_token || params.id_token) {",
							"      if (pm.environment.get(\"expectState\") === \"true\") {",
							"        if (params.state) {",
							"          pm.expect(params.state).to.equal(pm.variables.get(\"state\"));",
							"        } else {",
							"          console.log(\"Could not find state in Location header value.\");",
							"          pm.expect.fail(\"Could not find state in Location header value.\");",
							"        }",
							"      } else if (params.state) {",
							"        console.log(\"Unexpected state in Location header value.\");",
							"        pm.expect.fail(\"Unexpected state in Location header value.\");",
							"      }",
							"      if (params.access_token) {",
							"        pm.expect(params.access_token).to.be.a('string');",
							"        pm.environment.set(\"oauthToken\", params.access_token);",
							"        console.log(\"oauthToken is set\");",
							"      }",
							"      if (params.id_token) {",
							"        pm.expect(params.id_token).to.be.a('string');",
							"        pm.environment.set(\"idToken\", params.id_token);",
							"        console.log(\"idToken is set\");",
							"      }",
							"    } else if (params.error) {",
							"      console.log(\"An error occurred!\");",
							"      console.log(\"Error: \" + params.error);",
							"      if (params.error_description) {",
							"        console.log(\"Error description: \" + params.error_description);",
							"      }",
							"      pm.expect.fail(\"Location header contains an error.\");",
							"    } else {",
							"      console.log(\"Could not find flowId, access/id_token, or error in Location header value.\");",
							"      console.log(\"Location: \" + pm.response.headers.get(\"Location\"));",
							"      pm.expect.fail(\"Could not find flowId, access/id_token, or error in Location header value.\");",
							"    }",
							"  });",
							"}",
							"",
							"pm.test(\"If session cookie is sent it is 'httpOnly'\", function () {",
							"  const sessionCookie = new Cookie(pm.response.headers.get(\"Set-Cookie\"));",
							"  if (sessionCookie.value) {",
							"    // Check 'httpOnly' flag is set",
							"    pm.expect(sessionCookie.httpOnly).to.be.true;",
							"    // Store value of ST",
							"    pm.environment.set('sessionToken', sessionCookie.value);",
							"    console.log(\"sessionToken is now: \" + pm.environment.get(\"sessionToken\"));",
							"  } else {",
							"    console.log(\"Session Token not updated.\");",
							"  }",
							"});"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');",
							"",
							"pm.environment.set(\"state\", uuid());",
							"pm.environment.set(\"nonce\", uuid());",
							"const verifier = uuid() + uuid();",
							"pm.environment.set(\"codeVerifier\", verifier);",
							"pm.environment.set(\"codeChallenge\", base64ToURL(CryptoJS.SHA256(verifier).toString(CryptoJS.enc.Base64)));",
							"",
							"function base64ToURL(str) {",
							"  return str.replace(/\\+/g, '-')",
							"    .replace(/\\//g, '_')",
							"    .replace(/=/g, '');",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "GET",
				"header": [
					{
						"key": "Cookie",
						"value": "ST={{sessionToken}}",
						"disabled": true
					},
					{
						"key": "Cookie",
						"value": "ST-NO-SS={{sessionToken}}",
						"description": "Used for browsers that improperly handle SameSite=None",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{authPath}}/{{envID}}/as/authorize?response_type=code&client_id={{PKCEAppID}}&redirect_uri=https://www.example.com&scope=openid&code_challenge={{codeChallenge}}&code_challenge_method=S256",
					"host": [
						"{{authPath}}"
					],
					"path": [
						"{{envID}}",
						"as",
						"authorize"
					],
					"query": [
						{
							"key": "response_type",
							"value": "code",
							"description": "Required"
						},
						{
							"key": "client_id",
							"value": "{{PKCEAppID}}",
							"description": "Required"
						},
						{
							"key": "redirect_uri",
							"value": "https://www.example.com",
							"description": "Required "
						},
						{
							"key": "scope",
							"value": "openid",
							"description": "Optional - if empty, uses all granted scopes"
						},
						{
							"key": "code_challenge",
							"value": "{{codeChallenge}}",
							"description": "(S256) Required/Optional depending on App config - {{codeChallenge}} is automatically set to the S256 hashed value of {{codeVerifier}}"
						},
						{
							"key": "code_challenge_method",
							"value": "S256",
							"description": "Required/Optional depending on App config - Defaults to plain"
						},
						{
							"key": "response_mode",
							"value": "pi.flow",
							"description": "Optional ( query | fragment )",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Step 3: Verify Flow Initialization",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "GET",
				"header": [
					{
						"key": "Cookie",
						"value": "ST={{sessionToken}}",
						"description": "Use this for localhost",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{authPath}}/{{envID}}/flows/{{flowID}}",
					"host": [
						"{{authPath}}"
					],
					"path": [
						"{{envID}}",
						"flows",
						"{{flowID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Step 4: Submit Username and Password",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/vnd.pingidentity.usernamePassword.check+json"
					},
					{
						"key": "Cookie",
						"value": "ST={{sessionToken}}",
						"description": "Use this for localhost",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"username\": \"{{username}}\",\n    \"password\": \"{{password}}\"\n}"
				},
				"url": {
					"raw": "{{authPath}}/{{envID}}/flows/{{flowID}}",
					"host": [
						"{{authPath}}"
					],
					"path": [
						"{{envID}}",
						"flows",
						"{{flowID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Step 5: Call the Resume Endpoint",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const url = require('url');",
							"const querystring = require('querystring');",
							"const Cookie = require('postman-collection').Cookie;",
							"const isPiFlow = pm.environment.get(\"piFlowMode\") === \"true\";",
							"",
							"if (isPiFlow) {",
							"  pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"  });",
							"",
							"  const jsonData = pm.response.json();",
							"",
							"  pm.test(\"Response contains a 'status', as well as expected info for that status\", function () {",
							"    const flowStatus = jsonData.status;",
							"    if (flowStatus) {",
							"      pm.expect(flowStatus).to.be.a('string');",
							"      switch (flowStatus) {",
							"        case \"COMPLETED\":",
							"          const authorizeResponse = jsonData.authorizeResponse;",
							"          pm.expect(authorizeResponse).to.be.an('object');",
							"          if (authorizeResponse.code) {",
							"            pm.expect(authorizeResponse.code).to.be.a('string');",
							"            pm.environment.set(\"authCode\", authorizeResponse.code);",
							"            console.log(\"authCode is set\");",
							"          } else if (authorizeResponse.access_token || authorizeResponse.id_token) {",
							"            if (authorizeResponse.access_token) {",
							"              pm.expect(authorizeResponse.access_token).to.be.a('string');",
							"              pm.environment.set(\"oauthToken\", authorizeResponse.access_token);",
							"              console.log(\"oauthToken is set\");",
							"            }",
							"            if (authorizeResponse.id_token) {",
							"              pm.expect(authorizeResponse.id_token).to.be.a('string');",
							"              pm.environment.set(\"idToken\", authorizeResponse.id_token);",
							"              console.log(\"idToken is set\");",
							"            }",
							"          }",
							"          break;",
							"        case \"FAILED\":",
							"          const flowError = jsonData.error;",
							"          pm.expect(flowError).to.be.an('object');",
							"          console.log(\"An error occurred: \");",
							"          console.log(JSON.stringify(flowError));",
							"          pm.expect.fail(\"Flow FAILED.\");",
							"          break;",
							"        default:",
							"          console.log(\"Unexpected status!\");",
							"          console.log(\"Flow Status is: \" + flowStatus);",
							"          pm.expect.fail(\"Unexpected status!\");",
							"      }",
							"    } else {",
							"      const errorDetails = jsonData.details;",
							"      pm.expect(errorDetails).to.be.an('array');",
							"      console.log(\"An error occurred: \");",
							"      console.log(JSON.stringify(errorDetails[0]));",
							"    }",
							"  });",
							"",
							"  pm.test(\"If expected, response contains a 'state' that matches the current {{state}}\", function () {",
							"    const authorizeResponse = jsonData.authorizeResponse;",
							"    pm.expect(authorizeResponse).to.be.an('object');",
							"    if (pm.environment.get(\"expectState\") === \"true\") {",
							"      if (authorizeResponse.state) {",
							"        pm.expect(authorizeResponse.state).to.equal(pm.variables.get(\"state\"));",
							"      } else {",
							"        console.log(\"Could not find state in Location header value.\");",
							"        pm.expect.fail(\"Could not find state in Location header value.\");",
							"      }",
							"    } else if (authorizeResponse.state) {",
							"      console.log(\"Unexpected state in Location header value.\");",
							"      pm.expect.fail(\"Unexpected state in Location header value.\");",
							"    }",
							"  });",
							"} else {",
							"  pm.test(\"Status code is 302\", function () {",
							"    pm.response.to.have.status(302);",
							"  });",
							"",
							"  const loc = url.parse(pm.response.headers.get(\"Location\"));",
							"  var params = {};",
							"  if (loc.hash) {",
							"    params = querystring.parse(loc.hash.substring(1));",
							"  } else {",
							"    params = querystring.parse(loc.query);",
							"  }",
							"",
							"  pm.test(\"Location header contains an 'access_token' and/or 'id_token', or a 'code'\", function () {",
							"    if (params.access_token || params.id_token) {",
							"      if (params.access_token) {",
							"        pm.expect(params.access_token).to.be.a('string');",
							"        pm.environment.set(\"oauthToken\", params.access_token);",
							"        console.log(\"oauthToken is set\");",
							"      }",
							"      if (params.id_token) {",
							"        pm.expect(params.id_token).to.be.a('string');",
							"        pm.environment.set(\"idToken\", params.id_token);",
							"        console.log(\"idToken is set\");",
							"      }",
							"    } else if (params.code) {",
							"      pm.expect(params.code).to.be.a('string');",
							"      pm.environment.set(\"authCode\", params.code);",
							"      console.log(\"authCode is set\");",
							"    } else if (params.error) {",
							"      console.log(\"An error occurred: \");",
							"      console.log(\"Error: \" + params.error);",
							"      if (params.error_description) {",
							"        console.log(\"Error description: \" + params.error_description);",
							"      }",
							"      pm.expect.fail();",
							"    } else {",
							"      console.log(\"Could not find access token, ID token, or error in Location header value.\");",
							"      console.log(\"Location: \" + pm.response.headers.get(\"Location\"));",
							"      pm.expect.fail();",
							"    }",
							"  });",
							"",
							"  pm.test(\"If expected, Location header contains a 'state' that matches the current {{state}}\", function () {",
							"    if (pm.environment.get(\"expectState\") === \"true\") {",
							"      if (params.state) {",
							"        pm.expect(params.state).to.equal(pm.variables.get(\"state\"));",
							"      } else {",
							"        console.log(\"Could not find state in Location header value.\");",
							"        pm.expect.fail();",
							"      }",
							"    } else if (params.state) {",
							"      console.log(\"Unexpected state in Location header value.\");",
							"      pm.expect.fail();",
							"    }",
							"  });",
							"}",
							"",
							"pm.test(\"If session cookie is sent it is 'httpOnly'\", function () {",
							"  const sessionCookie = new Cookie(pm.response.headers.get(\"Set-Cookie\"));",
							"  if (sessionCookie.value) {",
							"    // Check 'httpOnly' flag is set",
							"    pm.expect(sessionCookie.httpOnly).to.be.true;",
							"    // Store value of ST",
							"    pm.environment.set('sessionToken', sessionCookie.value);",
							"    console.log(\"sessionToken is now: \" + pm.environment.get(\"sessionToken\"));",
							"  } else {",
							"    console.log(\"Session Token not updated.\");",
							"  }",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "GET",
				"header": [
					{
						"key": "Cookie",
						"value": "ST={{sessionToken}}",
						"disabled": true
					},
					{
						"description": "Used for browsers that improperly handle SameSite=None",
						"key": "Cookie",
						"type": "text",
						"value": "ST-NO-SS={{sessionToken}}",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{authPath}}/{{envID}}/as/resume?flowId={{flowID}}",
					"host": [
						"{{authPath}}"
					],
					"path": [
						"{{envID}}",
						"as",
						"resume"
					],
					"query": [
						{
							"key": "flowId",
							"value": "{{flowID}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Step 6: Get the token",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/x-www-form-urlencoded"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{accessToken}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "grant_type",
							"value": "authorization_code",
							"description": "Required",
							"type": "text"
						},
						{
							"key": "code",
							"value": "{{authCode}}",
							"description": "Required",
							"type": "text"
						},
						{
							"key": "redirect_uri",
							"value": "https://www.example.com",
							"description": "Required",
							"type": "text"
						},
						{
							"key": "client_id",
							"value": "{{PKCEAppID}}",
							"description": "Required",
							"type": "text"
						},
						{
							"key": "code_verifier",
							"value": "{{codeVerifier}}",
							"description": "Required",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{authPath}}/{{envID}}/as/token",
					"host": [
						"{{authPath}}"
					],
					"path": [
						"{{envID}}",
						"as",
						"token"
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	]
}